# VLIAS CRM 权限3级结构设计文档

## 概述

VLIAS CRM 系统采用3级权限结构设计，提供更细粒度的权限控制和更好的权限管理体验。

## 权限层级结构

### 权限类型定义

| 权限类型 | 编码 | 说明 | 示例 |
|---------|------|------|------|
| 一级权限(模块) | 1 | 系统顶级功能模块 | 组织架构、系统管理、商品管理 |
| 二级权限(子模块) | 2 | 模块下的子功能模块 | 组织机构管理、部门管理、岗位管理 |
| 三级权限(操作) | 3 | 具体的操作权限 | 查看、新增、编辑、删除 |

### 权限层级关系

```
一级权限(模块)
├── 二级权限(子模块)
│   ├── 三级权限(操作)
│   ├── 三级权限(操作)
│   └── 三级权限(操作)
├── 二级权限(子模块)
│   ├── 三级权限(操作)
│   └── 三级权限(操作)
└── 二级权限(子模块)
    └── 三级权限(操作)
```

### 实际权限示例

```
组织架构 (org)
├── 组织机构管理 (org-management)
│   ├── 查看 (org-management:view)
│   ├── 新增 (org-management:create)
│   ├── 编辑 (org-management:edit)
│   └── 删除 (org-management:delete)
├── 部门管理 (dept-management)
│   ├── 查看 (dept-management:view)
│   ├── 新增 (dept-management:create)
│   ├── 编辑 (dept-management:edit)
│   └── 删除 (dept-management:delete)
└── 岗位管理 (position-management)
    ├── 查看 (position-management:view)
    ├── 新增 (position-management:create)
    ├── 编辑 (position-management:edit)
    └── 删除 (position-management:delete)
```

## 数据库设计

### 权限表结构 (sys_permission)

```sql
CREATE TABLE `sys_permission` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `permission_name` varchar(100) NOT NULL COMMENT '权限名称',
  `permission_code` varchar(200) NOT NULL COMMENT '权限编码',
  `permission_type` int NOT NULL COMMENT '权限类型 1-一级权限(模块) 2-二级权限(子模块) 3-三级权限(操作)',
  `parent_id` bigint DEFAULT '0' COMMENT '父权限ID',
  `menu_id` bigint DEFAULT NULL COMMENT '关联菜单ID',
  `description` text COMMENT '权限描述',
  `sort_order` int DEFAULT '0' COMMENT '排序字段',
  `is_deleted` tinyint(1) DEFAULT '0' COMMENT '是否删除 0-未删除 1-已删除',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_permission_code` (`permission_code`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_permission_type` (`permission_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统权限表';
```

### 权限数据统计

- **一级权限（模块）**: 15个
- **二级权限（子模块）**: 56个  
- **三级权限（操作）**: 12个
- **总计**: 83个权限

### 权限编码规范

1. **一级权限**: 简短英文标识符
   - 示例: `org`, `system`, `product`

2. **二级权限**: 一级权限编码 + 功能描述
   - 示例: `org-management`, `dept-management`, `user-management`

3. **三级权限**: 二级权限编码 + 操作类型
   - 示例: `org-management:view`, `dept-management:create`

## 后端实现

### 实体类设计

```java
@Entity
@Table(name = "sys_permission")
public class SysPermission {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "permission_name", nullable = false, length = 100)
    private String permissionName;
    
    @Column(name = "permission_code", nullable = false, length = 200, unique = true)
    private String permissionCode;
    
    /**
     * 权限类型 1-一级权限(模块) 2-二级权限(子模块) 3-三级权限(操作)
     */
    @Column(name = "permission_type", nullable = false)
    private Integer permissionType;
    
    @Column(name = "parent_id")
    private Long parentId = 0L;
    
    @Column(name = "menu_id")
    private Long menuId;
    
    // ... 其他字段
}
```

### DTO设计

```java
public class PermissionDTO {
    private Long id;
    private String permissionName;
    private String permissionCode;
    
    /**
     * 权限类型 1-一级权限(模块) 2-二级权限(子模块) 3-三级权限(操作)
     */
    private Integer permissionType;
    
    private Long parentId;
    private Long menuId;
    private String description;
    private Integer sortOrder;
    private List<PermissionDTO> children;
    
    // ... getter/setter
}
```

### 服务层实现

```java
@Service
public class SysPermissionServiceImpl implements SysPermissionService {
    
    /**
     * 构建权限树结构
     */
    public List<PermissionDTO> buildPermissionTree(List<PermissionDTO> permissions) {
        Map<Long, PermissionDTO> permissionMap = new HashMap<>();
        List<PermissionDTO> rootPermissions = new ArrayList<>();
        
        // 构建权限映射
        for (PermissionDTO permission : permissions) {
            permissionMap.put(permission.getId(), permission);
            permission.setChildren(new ArrayList<>());
        }
        
        // 构建树结构
        for (PermissionDTO permission : permissions) {
            if (permission.getParentId() == null || permission.getParentId() == 0) {
                rootPermissions.add(permission);
            } else {
                PermissionDTO parent = permissionMap.get(permission.getParentId());
                if (parent != null) {
                    parent.getChildren().add(permission);
                }
            }
        }
        
        return rootPermissions;
    }
}
```

## 前端实现

### 权限类型配置

```javascript
// 权限类型选项
const permissionTypeOptions = [
  { value: 1, label: '一级权限(模块)' },
  { value: 2, label: '二级权限(子模块)' },
  { value: 3, label: '三级权限(操作)' }
]
```

### 权限显示样式

```vue
<template>
  <el-table :data="permissions" :row-class-name="getRowClassName">
    <el-table-column label="权限名称" min-width="300">
      <template #default="{ row }">
        <div :class="getPermissionClass(row)">
          <i :class="getIconClass(row)"></i>
          <span>{{ row.permissionName }}</span>
          <el-tag :type="getTagType(row)" size="small">
            {{ getPermissionTypeText(row.permissionType) }}
          </el-tag>
        </div>
      </template>
    </el-table-column>
    
    <el-table-column label="权限编码" width="200">
      <template #default="{ row }">
        <span :class="getCodeClass(row)">{{ row.permissionCode }}</span>
      </template>
    </el-table-column>
  </el-table>
</template>
```

### 权限样式定义

```scss
/* 一级权限样式 */
.module-permission {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* 二级权限样式 */
.submodule-permission {
  display: flex;
  align-items: center;
  gap: 8px;
  padding-left: 12px;
}

/* 三级权限样式 */
.child-permission {
  display: flex;
  align-items: center;
  gap: 8px;
  padding-left: 24px;
}

/* 图标样式 */
.module-icon {
  font-size: 18px;
  color: #409EFF;
}

.submodule-icon {
  font-size: 16px;
  color: #909399;
}

.action-icon {
  font-size: 16px;
  color: #67C23A;
}

/* 权限编码样式 */
.module-code {
  background-color: #E6F7FF;
  border: 1px solid #91D5FF;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: bold;
  color: #1890FF;
}

.submodule-code {
  background-color: #F5F5F5;
  border: 1px solid #D9D9D9;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  color: #909399;
}

.action-code {
  background-color: #F6FFED;
  border: 1px solid #B7EB8F;
  padding: 3px 6px;
  border-radius: 3px;
  font-size: 11px;
  color: #52C41A;
}
```

### 权限操作逻辑

```javascript
// 添加子权限
const addChildPermission = (parentPermission) => {
  const childType = parentPermission.permissionType === 1 ? 2 : 3
  
  dialogForm.value = {
    permissionName: '',
    permissionCode: '',
    permissionType: childType,
    parentId: parentPermission.id,
    menuId: null,
    description: '',
    sortOrder: 0
  }
  
  dialogVisible.value = true
  dialogTitle.value = '添加子权限'
}

// 获取父权限选项
const getParentOptions = (permissionType) => {
  if (permissionType === 1) {
    return [] // 一级权限无父权限
  } else if (permissionType === 2) {
    return permissions.value.filter(p => p.permissionType === 1) // 二级权限的父权限是一级权限
  } else if (permissionType === 3) {
    return permissions.value.filter(p => p.permissionType === 2) // 三级权限的父权限是二级权限
  }
  return []
}
```

## API接口设计

### 权限管理接口

```javascript
// 获取权限列表
export const getPermissions = () => {
  return request({
    url: '/api/sys/permissions',
    method: 'get'
  })
}

// 创建权限
export const createPermission = (data) => {
  return request({
    url: '/api/sys/permissions',
    method: 'post',
    data
  })
}

// 更新权限
export const updatePermission = (id, data) => {
  return request({
    url: `/api/sys/permissions/${id}`,
    method: 'put',
    data
  })
}

// 删除权限
export const deletePermission = (id) => {
  return request({
    url: `/api/sys/permissions/${id}`,
    method: 'delete'
  })
}

// 获取权限树
export const getPermissionTree = () => {
  return request({
    url: '/api/sys/permissions/tree',
    method: 'get'
  })
}
```

## 权限校验机制

### 后端权限校验

```java
@PreAuthorize("hasPermission('org-management:view')")
@GetMapping("/organizations")
public ResponseEntity<List<OrganizationDTO>> getOrganizations() {
    // 查看组织机构列表
}

@PreAuthorize("hasPermission('org-management:create')")
@PostMapping("/organizations")
public ResponseEntity<OrganizationDTO> createOrganization(@RequestBody OrganizationDTO dto) {
    // 创建组织机构
}
```

### 前端权限校验

```javascript
// 权限指令
Vue.directive('permission', {
  inserted(el, binding) {
    const { value } = binding
    const permissions = store.getters.permissions
    
    if (value && !permissions.includes(value)) {
      el.parentNode && el.parentNode.removeChild(el)
    }
  }
})

// 使用示例
<el-button v-permission="'org-management:create'" type="primary">
  新增组织
</el-button>
```

## 权限继承规则

### 权限继承关系

1. **用户拥有一级权限** → 自动拥有该模块下所有二级和三级权限
2. **用户拥有二级权限** → 自动拥有该子模块下所有三级权限
3. **用户拥有三级权限** → 仅拥有该具体操作权限

### 权限检查算法

```java
public boolean hasPermission(String permissionCode) {
    // 1. 直接权限检查
    if (userPermissions.contains(permissionCode)) {
        return true;
    }
    
    // 2. 继承权限检查
    String[] parts = permissionCode.split(":");
    if (parts.length == 2) {
        // 检查是否有二级权限
        String submoduleCode = parts[0];
        if (userPermissions.contains(submoduleCode)) {
            return true;
        }
        
        // 检查是否有一级权限
        String[] subParts = submoduleCode.split("-");
        if (subParts.length > 0) {
            String moduleCode = subParts[0];
            if (userPermissions.contains(moduleCode)) {
                return true;
            }
        }
    }
    
    return false;
}
```

## 最佳实践

### 权限设计原则

1. **最小权限原则**: 用户默认没有任何权限，需要明确授予
2. **权限继承**: 上级权限包含下级权限的所有操作
3. **权限分离**: 不同模块的权限相互独立
4. **操作明确**: 每个三级权限对应一个明确的操作

### 权限命名规范

1. **一级权限**: 使用简短的英文单词，如 `org`, `system`, `product`
2. **二级权限**: 使用 `模块-功能` 格式，如 `org-management`, `user-management`
3. **三级权限**: 使用 `二级权限:操作` 格式，如 `org-management:view`, `user-management:create`

### 权限管理建议

1. **定期审查**: 定期检查用户权限，清理不必要的权限
2. **权限文档**: 维护权限清单和说明文档
3. **测试验证**: 对权限控制进行充分测试
4. **日志记录**: 记录权限变更和敏感操作日志

## 总结

VLIAS CRM 的3级权限结构提供了灵活而强大的权限管理能力：

- **一级权限(模块)**: 提供模块级别的访问控制
- **二级权限(子模块)**: 提供功能级别的访问控制  
- **三级权限(操作)**: 提供操作级别的精细控制

这种设计既保证了权限控制的细粒度，又保持了良好的可维护性和用户体验。通过权限继承机制，简化了权限分配的复杂度，同时通过清晰的权限层级结构，让权限管理更加直观和易于理解。 