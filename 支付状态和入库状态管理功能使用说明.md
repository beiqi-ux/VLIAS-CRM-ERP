# 支付状态和入库状态管理功能使用说明

## 功能概述

为了方便管理采购订单的支付状态和入库状态，系统新增了专门的编辑功能。用户可以在采购订单详情页面直接修改这两个状态，无需通过复杂的业务流程。

## 功能位置

### 访问路径
1. 进入 **采购管理** > **采购订单管理**
2. 点击任意订单的 **订单号** 进入详情页面
3. 在详情页面底部的操作按钮区域可以看到：
   - **编辑支付状态** 按钮
   - **编辑入库状态** 按钮（仅在订单已审核后显示）

## 支付状态管理

### 功能说明
- **位置**：订单详情页面 > 操作按钮区域 > "编辑支付状态"
- **权限要求**：需要 `purchase-order-management:update` 权限
- **适用状态**：除已取消订单外的所有订单状态

### 操作步骤
1. 点击 **编辑支付状态** 按钮
2. 在弹出的对话框中：
   - **支付状态**：选择未支付/部分支付/已支付
   - **已付金额**：输入实际已付金额（不能超过订单总金额）
   - **备注**：可选，输入支付相关备注信息
3. 点击 **确定** 保存修改

### 智能计算规则
系统会根据已付金额自动计算支付状态：
- 已付金额 = 0 → 自动设为"未支付"
- 已付金额 = 订单总金额 → 自动设为"已支付"  
- 0 < 已付金额 < 订单总金额 → 自动设为"部分支付"

### 验证规则
- 已付金额不能为负数
- 已付金额不能超过订单总金额
- 已取消的订单不能修改支付状态

## 入库状态管理

### 功能说明
- **位置**：订单详情页面 > 操作按钮区域 > "编辑入库状态"
- **权限要求**：需要 `purchase-order-management:update` 权限
- **适用状态**：仅限已审核（状态≥3）的订单

### 操作步骤
1. 点击 **编辑入库状态** 按钮
2. 在弹出的对话框中：
   - **入库状态**：选择未入库/部分入库/已入库
   - **备注**：可选，输入入库相关备注信息
3. 点击 **确定** 保存修改

### 状态联动规则
修改入库状态会自动更新订单状态：
- 入库状态 = "已入库" → 订单状态自动变为"已完成"
- 入库状态 = "部分入库" → 订单状态自动变为"部分入库"

### 验证规则
- 只有已审核的订单才能修改入库状态
- 已取消的订单不能修改入库状态
- 草稿和待审核状态的订单不显示入库状态编辑按钮

## 后端接口说明

### 支付状态更新接口
```
PUT /api/purchase-orders/{id}/payment-status
Content-Type: application/json

{
  "payStatus": 1,          // 支付状态：0-未支付, 1-部分支付, 2-已支付
  "paidAmount": 1200.00,   // 已付金额
  "remark": "银行转账支付"   // 备注（可选）
}
```

### 入库状态更新接口
```
PUT /api/purchase-orders/{id}/receipt-status
Content-Type: application/json

{
  "receiptStatus": 2,      // 入库状态：0-未入库, 1-部分入库, 2-已入库
  "remark": "货物已全部入库" // 备注（可选）
}
```

## 权限配置

确保相关用户具有以下权限：
- `purchase-order-management:view` - 查看订单详情
- `purchase-order-management:update` - 编辑支付和入库状态

## 操作日志

所有状态修改操作都会记录：
- 操作人员
- 操作时间  
- 修改前后的状态值
- 备注信息

## 注意事项

1. **数据一致性**：修改状态后会立即更新数据库，请谨慎操作
2. **业务流程**：此功能为快捷操作，不会触发相关的业务流程（如库存变动）
3. **权限控制**：确保只有授权人员可以修改这些关键状态
4. **状态联动**：修改入库状态可能会自动更新订单主状态，请注意影响范围

## 常见问题

**Q: 为什么看不到"编辑入库状态"按钮？**
A: 该按钮仅在订单状态为已审核（≥3）时显示，草稿和待审核状态的订单无法编辑入库状态。

**Q: 修改支付状态后订单状态会变化吗？**
A: 修改支付状态不会自动改变订单状态，只有修改入库状态才会联动更新订单状态。

**Q: 可以输入超过订单总金额的已付金额吗？**
A: 不可以，系统会验证已付金额不能超过订单总金额。

**Q: 修改状态需要审核吗？**
A: 不需要，修改后立即生效。建议建立相应的内控制度来规范操作权限。 