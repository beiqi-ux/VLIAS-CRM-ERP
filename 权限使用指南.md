# VLIAS CRM 权限使用指南

## 概述

VLIAS CRM 系统采用3级权限结构，并区分**UI显示权限检查**和**操作权限检查**两种不同的权限验证机制。

## 权限层级结构

### 权限编码规范

- **一级权限（模块）**: `org`, `system`, `product`
- **二级权限（子模块）**: `org-management`, `dept-management`, `user-management`
- **三级权限（操作）**: `org-management:view`, `org-management:create`, `org-management:edit`, `org-management:delete`

## 权限检查机制

### 1. UI显示权限检查（支持继承）

用于控制菜单、页面、表格列等UI元素的显示，支持权限继承。

**前端使用：**

```javascript
// 函数调用
import { hasPermission } from '@/utils/permission'

// 检查权限（支持继承）
if (hasPermission('org-management:view')) {
  // 显示相关UI
}

// Vue指令（用于UI显示控制）
<el-table-column v-permission="'org-management'" label="操作">
  <!-- 如果用户有org-management或org权限，则显示此列 -->
</el-table-column>

// 组合式API
import { usePermission } from '@/utils/permission'
const canViewOrg = usePermission('org-management:view')
```

**后端使用：**

```java
// 检查权限继承关系
boolean hasPermission = PermissionUtils.hasPermissionWithInheritance(userPermissions, "org-management:view");

// 或者使用服务层
boolean hasPermission = permissionService.hasPermissionWithInheritance(userPermissions, "org-management:view");
```

### 2. 操作权限检查（严格检查）

用于控制按钮点击、API调用等具体操作，不支持权限继承，必须拥有确切的权限。

**前端使用：**

```javascript
// 函数调用
import { hasActionPermission } from '@/utils/permission'

// 严格权限检查
if (hasActionPermission('org-management:delete')) {
  // 执行删除操作
}

// Vue指令（用于操作按钮控制）
<el-button v-action-permission="'org-management:create'" type="primary">
  新增组织
</el-button>

<el-button v-action-permission="'org-management:edit'" type="primary">
  编辑
</el-button>

<el-button v-action-permission="'org-management:delete'" type="danger">
  删除
</el-button>

// 组合式API
import { useActionPermission } from '@/utils/permission'
const canDeleteOrg = useActionPermission('org-management:delete')
```

**后端使用：**

```java
// 严格权限检查
boolean hasPermission = PermissionUtils.hasStrictPermission(userPermissions, "org-management:delete");

// 或者使用服务层
boolean hasPermission = permissionService.hasStrictPermission(userPermissions, "org-management:delete");

// Spring Security注解（推荐）
@PreAuthorize("hasAuthority('org-management:delete')")
public void deleteOrganization(Long id) {
    // 删除组织
}
```

## 权限继承规则

### 继承关系说明

1. **拥有一级权限** → 自动拥有该模块下所有二级和三级权限（仅限UI显示）
2. **拥有二级权限** → 自动拥有该子模块下所有三级权限（仅限UI显示）
3. **拥有三级权限** → 仅拥有该具体操作权限

### 示例说明

假设用户拥有权限：`['org-management']`

```javascript
// UI显示权限检查（支持继承）
hasPermission('org-management:view')    // true - 继承自org-management
hasPermission('org-management:create')  // true - 继承自org-management
hasPermission('org-management:edit')    // true - 继承自org-management
hasPermission('org-management:delete')  // true - 继承自org-management

// 操作权限检查（严格检查）
hasActionPermission('org-management:view')    // false - 需要确切权限
hasActionPermission('org-management:create')  // false - 需要确切权限
hasActionPermission('org-management:edit')    // false - 需要确切权限
hasActionPermission('org-management:delete')  // false - 需要确切权限
```

## 实际应用场景

### 场景1：组织架构管理页面

```vue
<template>
  <div class="organization-list">
    <el-card>
      <template #header>
        <div class="card-header">
          <span>组织机构管理</span>
          <!-- 操作按钮使用严格权限检查 -->
          <el-button 
            v-action-permission="'org-management:create'"
            type="primary" 
            @click="handleAdd"
          >
            新增组织机构
          </el-button>
        </div>
      </template>

      <el-table :data="orgList">
        <!-- 表格列使用UI显示权限检查 -->
        <el-table-column 
          v-permission="'org-management'"
          label="操作" 
          width="250"
        >
          <template #default="{ row }">
            <!-- 每个操作按钮都使用严格权限检查 -->
            <el-button 
              v-action-permission="'org-management:view'"
              size="small" 
              @click="handleView(row)"
            >
              查看
            </el-button>
            <el-button 
              v-action-permission="'org-management:edit'"
              type="primary" 
              size="small" 
              @click="handleEdit(row)"
            >
              编辑
            </el-button>
            <el-button 
              v-action-permission="'org-management:delete'"
              type="danger" 
              size="small" 
              @click="handleDelete(row)"
            >
              删除
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>
  </div>
</template>

<script setup>
import { hasPermission, hasActionPermission } from '@/utils/permission'

// 在JavaScript中使用权限检查
const handleAdd = () => {
  // 双重检查：UI显示 + 操作权限
  if (!hasActionPermission('org-management:create')) {
    ElMessage.error('您没有创建权限')
    return
  }
  // 执行创建逻辑
}
</script>
```

### 场景2：后端API权限控制

```java
@RestController
@RequestMapping("/api/organizations")
public class OrganizationController {
    
    // 查看权限 - 可以使用继承检查
    @GetMapping
    @PreAuthorize("hasAuthority('org-management:view')")
    public ResponseEntity<List<OrganizationDTO>> getOrganizations() {
        // 查看组织列表
        return ResponseEntity.ok(organizationService.findAll());
    }
    
    // 创建权限 - 必须使用严格检查
    @PostMapping
    @PreAuthorize("hasAuthority('org-management:create')")
    public ResponseEntity<OrganizationDTO> createOrganization(@RequestBody OrganizationDTO dto) {
        // 创建组织
        return ResponseEntity.ok(organizationService.create(dto));
    }
    
    // 编辑权限 - 必须使用严格检查
    @PutMapping("/{id}")
    @PreAuthorize("hasAuthority('org-management:edit')")
    public ResponseEntity<OrganizationDTO> updateOrganization(@PathVariable Long id, @RequestBody OrganizationDTO dto) {
        // 更新组织
        return ResponseEntity.ok(organizationService.update(id, dto));
    }
    
    // 删除权限 - 必须使用严格检查
    @DeleteMapping("/{id}")
    @PreAuthorize("hasAuthority('org-management:delete')")
    public ResponseEntity<Void> deleteOrganization(@PathVariable Long id) {
        // 删除组织
        organizationService.delete(id);
        return ResponseEntity.ok().build();
    }
}
```

## 权限配置建议

### 1. 角色权限分配

```javascript
// 管理员角色 - 拥有完整模块权限
const adminPermissions = [
  'org',           // 一级权限，自动继承所有子权限（UI显示）
  'system',        // 一级权限
  'product'        // 一级权限
]

// 部门经理角色 - 拥有部分子模块权限
const managerPermissions = [
  'org-management',              // 二级权限，继承所有操作权限（UI显示）
  'org-management:view',         // 明确的查看权限（操作）
  'org-management:edit',         // 明确的编辑权限（操作）
  'dept-management:view',        // 明确的部门查看权限（操作）
  'dept-management:edit'         // 明确的部门编辑权限（操作）
]

// 普通员工角色 - 仅拥有查看权限
const employeePermissions = [
  'org-management:view',         // 仅查看组织
  'dept-management:view'         // 仅查看部门
]
```

### 2. 权限分配原则

1. **最小权限原则**：用户默认没有任何权限，需要明确授予
2. **明确操作权限**：对于敏感操作（创建、编辑、删除），必须分配确切的操作权限
3. **UI显示优化**：可以分配上级权限来简化UI权限管理
4. **权限分离**：不同模块的权限相互独立

## 常见问题

### Q1: 为什么要区分UI显示权限和操作权限？

**A1**: 这样设计的目的是：
- **UI显示权限**：提供更好的用户体验，避免界面过于复杂
- **操作权限**：确保安全性，防止权限提升攻击

### Q2: 什么时候使用v-permission，什么时候使用v-action-permission？

**A2**: 
- **v-permission**：用于控制UI元素显示（表格列、菜单项、页面区块）
- **v-action-permission**：用于控制操作按钮（新增、编辑、删除、导出等）

### Q3: 后端API应该使用哪种权限检查？

**A3**: 
- **查看类API**：可以使用继承检查，提供更好的兼容性
- **操作类API**：必须使用严格检查，确保安全性

### Q4: 如何处理权限变更？

**A4**: 
- 用户权限变更后，前端需要重新获取用户信息
- 可以通过WebSocket或定期轮询来同步权限变更

## 总结

通过区分UI显示权限和操作权限，VLIAS CRM系统在保证安全性的同时，也提供了良好的用户体验。开发时请务必：

1. UI元素使用 `v-permission` 指令或 `hasPermission()` 函数
2. 操作按钮使用 `v-action-permission` 指令或 `hasActionPermission()` 函数  
3. 后端API根据操作类型选择合适的权限检查方式
4. 遵循最小权限原则进行权限分配 